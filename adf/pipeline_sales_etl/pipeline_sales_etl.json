{"$schema":"http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#","contentVersion":"1.0.0.0","parameters":{"factoryName":{"type":"string","metadata":"Data Factory name"},"ls_blob_etlstoragedemoalex":{"type":"string"}},"variables":{"factoryId":"[concat('Microsoft.DataFactory/factories/', parameters('factoryName'))]"},"resources":[{"name":"[concat(parameters('factoryName'), '/pipeline_sales_etl')]","type":"Microsoft.DataFactory/factories/pipelines","apiVersion":"2018-06-01","properties":{"description":"This pipeline orchestrates the end-to-end ETL process for sales data. It executes the Data Flow that performs data cleaning, enrichment, and aggregation, then writes the processed data to the 'processed' container in Azure Blob Storage. Designed to ensure data quality and enable advanced analytics on sales records.","activities":[{"name":"df_sales_transformations","description":"This pipeline orchestrates the end-to-end ETL process for sales data. It executes the Data Flow that performs data cleaning, enrichment, and aggregation, then writes the processed data to the 'processed' container in Azure Blob Storage. Designed to ensure data quality and enable advanced analytics on sales records.","type":"ExecuteDataFlow","dependsOn":[],"policy":{"timeout":"0.12:00:00","retry":0,"retryIntervalInSeconds":30,"secureOutput":false,"secureInput":false},"userProperties":[],"typeProperties":{"dataflow":{"referenceName":"df_sales_transformations","type":"DataFlowReference","parameters":{},"datasetParameters":{"SalesSource":{},"SinkProcessedSales":{}}},"staging":{},"compute":{"coreCount":8,"computeType":"General"},"traceLevel":"Fine"}}],"policy":{"elapsedTimeMetric":{}},"annotations":[]},"dependsOn":["[concat(variables('factoryId'), '/dataflows/df_sales_transformations')]"]},{"name":"[concat(parameters('factoryName'), '/df_sales_transformations')]","type":"Microsoft.DataFactory/factories/dataflows","apiVersion":"2018-06-01","properties":{"description":"ADF sales transformations","type":"MappingDataFlow","typeProperties":{"sources":[{"dataset":{"referenceName":"ds_sales_clean_csv","type":"DatasetReference"},"name":"SalesSource","description":"Load sales data from cleaned CSV stored in Azure Blob Storage (ds_sales_clean_csv)"}],"sinks":[{"dataset":{"referenceName":"SinkProcessedSales","type":"DatasetReference"},"name":"SinkProcessedSales","description":"Save processed sales data to the processed container in Azure Blob Storage"}],"transformations":[{"name":"FilterOrderAndShipDate","description":"Remove rows where order_date and ship_date are null to ensure only records with a valid order and ship date are processed."},{"name":"ConvertPostalCode","description":"Convert postal_code from float to string and remove decimals."},{"name":"AggregateByCustomer","description":"Aggregate sales metrics by customer: total sales, order count, last order date."},{"name":"ConvertSalesToNumber","description":"Convert sales column from string to number"},{"name":"FormatTotalSales","description":"Add $ symbol to total_sales and convert it to string."}],"scriptLines":["source(output(","          order_id as string,","          order_date as string,","          ship_date as string,","          ship_mode as string,","          customer_id as string,","          customer_name as string,","          segment as string,","          country as string,","          city as string,","          state as string,","          postal_code as string,","          region as string,","          product_id as string,","          category as string,","          sub_category as string,","          product_name as string,","          sales as string","     ),","     allowSchemaDrift: true,","     validateSchema: false,","     ignoreNoFilesFound: false) ~> SalesSource","SalesSource filter(!isNull(order_date) && !isNull(ship_date)","",") ~> FilterOrderAndShipDate","FilterOrderAndShipDate derive(postal_code = toString(toInteger(postal_code))) ~> ConvertPostalCode","ConvertSalesToNumber aggregate(groupBy(customer_id),","     total_sales = sum(sales),","          order_count = count(order_id),","          last_order_date = max(order_date)) ~> AggregateByCustomer","ConvertPostalCode derive(sales = toInteger(sales)) ~> ConvertSalesToNumber","AggregateByCustomer derive(total_sales = toString(total_sales) + ' $') ~> FormatTotalSales","FormatTotalSales sink(allowSchemaDrift: true,","     validateSchema: false,","     skipDuplicateMapInputs: true,","     skipDuplicateMapOutputs: true) ~> SinkProcessedSales"]}},"dependsOn":["[concat(variables('factoryId'), '/datasets/ds_sales_clean_csv')]","[concat(variables('factoryId'), '/datasets/SinkProcessedSales')]"]},{"name":"[concat(parameters('factoryName'), '/ds_sales_clean_csv')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"description":"sales dataset from raw container","linkedServiceName":{"referenceName":"[parameters('ls_blob_etlstoragedemoalex')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"sales_clean.csv","container":"raw"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[{"name":"order_id","type":"String"},{"name":"order_date","type":"String"},{"name":"ship_date","type":"String"},{"name":"ship_mode","type":"String"},{"name":"customer_id","type":"String"},{"name":"customer_name","type":"String"},{"name":"segment","type":"String"},{"name":"country","type":"String"},{"name":"city","type":"String"},{"name":"state","type":"String"},{"name":"postal_code","type":"String"},{"name":"region","type":"String"},{"name":"product_id","type":"String"},{"name":"category","type":"String"},{"name":"sub_category","type":"String"},{"name":"product_name","type":"String"},{"name":"sales","type":"String"}]},"dependsOn":[]},{"name":"[concat(parameters('factoryName'), '/SinkProcessedSales')]","type":"Microsoft.DataFactory/factories/datasets","apiVersion":"2018-06-01","properties":{"linkedServiceName":{"referenceName":"[parameters('ls_blob_etlstoragedemoalex')]","type":"LinkedServiceReference"},"annotations":[],"type":"DelimitedText","typeProperties":{"location":{"type":"AzureBlobStorageLocation","fileName":"processed_sales.csv","container":"processed"},"columnDelimiter":",","escapeChar":"\\","firstRowAsHeader":true,"quoteChar":"\""},"schema":[]},"dependsOn":[]}]}